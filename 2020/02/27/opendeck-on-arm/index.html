<!DOCTYPE html > <html lang="en-US"> <!-- Site Head --> <head> <meta charset="utf-8"> <title>Shantea Controls &#8226 OpenDeck on ARM</title> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="shortcut icon" href="/images/favicon.png" title="Favicon"> <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet"> <!-- Importing Styles --> <link rel="stylesheet" href="/css/style.css"> <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/css/lightgallery-bundle.min.css"> <style> .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 45px;
    }
  
    @media (max-width: 767px) {
      .markdown-body {
        padding: 15px;
      }
    } </style> </head> <body> <!-- Page Loader --> <div id="page-loader" class="page-loader"><span class="load-icon"></span></div> <!-- Site Header --> <header class="site-header blog-header parallax" id="home" data-scrollax-parent="true"> <!-- Parallax Header Image --> <div class="parallax-wrapper"> <div class="cover" data-scrollax="properties: { 'translateY': '48%' }"> <img style="min-width: 100%;" src="/images/blog/header.jpg"> </div> </div> <div class="container"> <!-- Site Navigation Bar --> <div class="row site-navigation-bar parent"> <!-- Logo --> <div class="col-sm-2 col-xs-4 logo child-center-v"> <a href="/index.html"><img src="/images/logo_notext.svg" width="70"></a> </div> <!-- Toggle Mobile Menu --> <div class="col-xs-8 toggle-menu child-center-v"> <!-- Burger --> <div class="navTrigger"> <i></i><i></i><i></i> </div> </div> <!-- Navigation Bar --> <div class="col-sm-10 col-xs-12 navigation-bar child-center-v"> <!-- Navigation Menu --> <nav id="navMenu" class="nav-menu"> <ul class="menu"> <li><a href="/#about">ABOUT</a></li> <li><a href="/#features">FEATURES</a></li> <li><a href="/#parallax-features">SPECS</a></li> <li><a href="/#portfolio">GALLERY</a></li> <li><a href="/#testimonials">TESTIMONIALS</a></li> <li class="current-menu-item"><a href="/blog">BLOG</a></li> <li><a href="/#prices">OFFERS</a></li> <li><a href="/#contact">CONTACT</a></li> </ul> </nav> </div> </div> <!-- Site Header Banner --> <div class="row header-banner parent" data-scrollax="properties: { 'translateY': '48%', 'opacity': '1.4' }"> <div class="heading-content text-center child-center-v"> <!-- Heading Title --> <div class="row heading-title"> <h2>Shantea Controls</h2> <hr class="small"> <h1 class="thin">OpenDeck on ARM</h1> </div> </div> </div> </div> </header> <!-- Page Section --> <section class="site-section blog-section page-layout" id="start"> <div class="container"> <!-- Page Layout --> <div class="row"> <!-- Sidebar --> <div class="col-md-4 hidden-xs hidden-sm"> <!-- Site Sidebar --> <aside class="site-sidebar"> <!-- Categories Widget --> <div class="widget categories-widget"> <!-- Widget Header --> <header class="widget-header"> <h4 class="widget-title">Categories</h4> </header> <!-- Widget Content --> <div class="widget-content"> <ul class="categories-box"> <li><a href="/category/info">info <span class="cat-count">9</span></a></li> <li><a href="/category/design">design <span class="cat-count">7</span></a></li> <li><a href="/category/build-log">build-log <span class="cat-count">9</span></a></li> <li><a href="/category/development">development <span class="cat-count">21</span></a></li> <li><a href="/category/programming">programming <span class="cat-count">5</span></a></li> </ul> </div> </div> </aside> </div> <!-- Content --> <div class="col-md-8 blog-articles-container"> <!-- Blog Article --> <div class="post-full"> <article class="blog-article blog-single-page clearfix"> <!-- Article Header --> <header class="article-header"> <div class="img-wrap"> <img src="/images/blog/stm32f4discovery.jpg" alt="Article Blog Image"> </div> </header> <!-- Article Content --> <article class="markdown-body"> <p>A little over two years ago, I’ve announced that <a href="https://shanteacontrols.com/2017/12/14/opendeck-on-arduino/">OpenDeck firmware started supporting various Arduino boards</a>. It was a major milestone - the firmware design was modular enough that it could support various targets instead of just official OpenDeck board. Now, it’s time to announce another major milestone: OpenDeck can now run on 32-bit STM32 microcontrollers!</p> <h2 id="rationale">Rationale</h2> <p>You might be wondering why OpenDeck needs to support ARM when everything works fine as is. Perhaps ironically, over the last few months the target with which I had the most issues supporting it was my own official OpenDeck board. That board is based on ATmega32u4 AVR microcontroller. Let’s get over the specs of that particular MCU:</p> <ul> <li>8-bit architecture</li> <li>16MHz</li> <li>32KB flash program memory</li> <li>2.5KB SRAM</li> <li>1KB EEPROM</li> <li>10-bit A/D-converter</li> <li>USB 2.0</li> </ul> <p>Its specs are quite poor, however, it was a good choice when I first started developing OpenDeck, since Arduino Leonardo used that same MCU, and I was using Arduino Leonardo for prototyping. Over the time, as the amount of OpenDeck features grew, the memory requirements also grew. I’ve managed to mitigate this by writing more compact code when possible and by enabling more and more compiler optimizations. With each optimization, I bought myself some more memory and more time until I couldn’t optimize the code anymore so that it could fit inside the MCU. Here are the results when building the firmware I’ve released today for OpenDeck board:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AVR Memory Usage
----------------
Device: atmega32u4

Program: 28392 bytes (86.6% Full)
(.text + .data + .bootloader)

Data: 2326 bytes (90.9% Full)
(.data + .bss + .noinit)
</code></pre></div></div> <p>Program usage is a bit misleading, though, since 4kB of flash is reserved for bootloader, which brings the total memory usage to 99%. I’ve only got 280 bytes left which means it has become impossible to add any more features to the official board. On top of this, ATmega32u4 only has 1kB of EEPROM memory, which means I cannot support presets on official board since the current configuration takes almost the entire EEPROM as well.</p> <h2 id="solution">Solution</h2> <p>I could’ve solved most of these issues simply by making new OpenDeck board with another beefier AVR MCU, such as AT90USB1286. That MCU has 128kB of flash, 8kB of RAM and 4kB of EEPROM. Even though I could get along with 128kB of flash and 8kB of RAM, this MCU still has same 8-bit architecture, runs on same 16 MHz clock so it has fairly limited processing power and limited EEPROM. I don’t really need more processing power right now, but I might in the future. There’s also the issue of pricing (this thing costs about 7$) and with AVR loosing on all fronts compared to vastly more powerful ARM MCUs, it is a question for how long these MCUs are going to be available. I want my next flagship board to be based on something I can count on for the next decade. It’s still probably going to be around by then, however, OpenDeck firmware might eat the resources of that MCU as well. Therefore, the only logical choice was to move to something powerful enough that I won’t need to worry about resources for a very long time. I had some prior experience with STM32 line from ST so I’ve picked STM32F4 Discovery board to be the first supported OpenDeck target.</p> <p><img src="/images/blog/stm32f4discovery.jpg" alt=""></p> <p>This particular board has STM32F407VG MCU with the following specs:</p> <ul> <li>32 bit architecture</li> <li>168MHz clock</li> <li>1MB of flash</li> <li>192kB of RAM</li> <li>12-bit ADC</li> <li>USB</li> <li>Loads of peripherals</li> </ul> <p>Even though most modern ARM MCUs don’t have EEPROM, it can be simulated using flash memory. Because of this, I have currently dedicated 16kB of flash to virtual EEPROM on this MCU, which means that I can support many presets.</p> <p>Compared to even the most powerful AVR, this thing is a beast. The great thing about this board is that it also features on-board programmer/debugger so it’s really easy to develop on. This entire board is fairly cheap as well - less than 20$.</p> <p>Currently, most of the things work on this board:</p> <ul> <li>USB MIDI</li> <li>Virtual EEPROM</li> <li>Configuration via web interface</li> <li>I/O</li> </ul> <p>The only thing I’m missing at the moment is bootloader support which will come in the coming weeks. Other stuff works for now, but I still consider this experimental since it it has undergone limited amount of testing.</p> <p>[caption id=”attachment_2695” align=”aligncenter” width=”900”]![]</p> <p>Since I still consider this experimental, there is currently no documentation on OpenDeck wiki on how to flash this board - this will come soon hopefully. Good news is that it’s much simpler to flash this board than any other Arduino board simply because this board already has integrated programmer so no external components are needed.</p> <h2 id="the-future">The future</h2> <p>Later this year I am planning on releasing OpenDeck board v2 which will feature STM32F405 MCU. It will come most likely some time after summer. It will feature exactly the same amount of inputs and outputs as the current board. It will also have exactly the same dimensions. I have also managed to include some more stuff on it:</p> <ul> <li>I2C connector</li> <li>SPI connector</li> <li>Additional UART connector</li> </ul> <p>I want this board to support many peripherals which is why I have included these connectors.</p> <p>Every other supported board variant will be still supported, but the firmware for current OpenDeck board won’t receive any new features (other than the bug fixes) since I simply have no more memory to use as mentioned above. I am also planning on releasing OpenDeck Mega, which will have support for at least:</p> <ul> <li>128 buttons</li> <li>128 LEDs</li> <li>64 analog components</li> <li>Dual DIN MIDI connectors</li> <li>Probably some more stuff</li> </ul> <p>If anyone has some suggestions for Mega board, let me know! I get loads of requests asking for board which supports many components, so OpenDeck Mega will be the long awaited answer to that.</p> </article> <!-- Article Tool Boxes --> <div class="article-boxes"> <!-- Tags Box --> <div class="tags-article box"> <span class="title">Tags:</span> <ul class="tag-cloud-box box-content"> <li><a href="/tag/arm">arm</a></li> <li><a href="/tag/mega">mega</a></li> <li><a href="/tag/opendeck">opendeck</a></li> <li><a href="/tag/stm32">stm32</a></li> </ul> </div> </div> </article> </div> </div> </div> </div> </section> <!-- Site Footer --> <footer class="site-footer" id="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-md-push-3 footer-info text-center"> <div class="footer-logo"> <img src="/images/logo.svg" width="700"> </div> <div class="footer-info-text"> <p></p> </div> <div class="social-icons"> <ul class="icons"> <li><a href="https://youtube.com/shanteacontrols" target="_blank"><i class="fi flaticon-youtube"></i></a></li> <li><a href="https://www.facebook.com/shanteacontrolsmidi" target="_blank"><i class="fi flaticon-facebook"></i></a></li> </ul> </div> </div> <div class="col-md-8 col-md-push-2 footer-copyright"> <div class="footer-text text-center"> <p>All Rights Reserved</p> <p><a href="https://shanteacontrols.com/">Shantea Controls</a> &copy; 2022</p> </div> </div> </div> </div> </footer> <!-- Go To Top Button --> <a href="#home" class="go-to-top-button"><i class="pe-7s-angle-up"></i></a> <!-- Importing Scripts --> <!-- jQuery CDN --> <script src="//ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script> <!-- If CDN fails than use local jQuery --> <script>window.jQuery || document.write('<script src="/js/jquery-3.0.0.min.js"><\/script>')</script> <!-- Owl Carousel --> <script src="/js/carousel.min.js" charset="utf-8"></script> <!-- Parallaxing & SmoothScroll --> <script src="/js/scrollax.min.js" charset="utf-8"></script> <!-- Main JS --> <script src="/js/main.js" charset="utf-8"></script> <!-- LightGallery --> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/lightgallery.umd.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/plugins/thumbnail/lg-thumbnail.umd.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/plugins/zoom/lg-zoom.umd.min.js"></script> <script type="text/javascript"> lightGallery(document.getElementById('gallery-container'), {
        plugins: [lgThumbnail],
        speed: 250,
        licenseKey: "xAIQA"
    }); </script> </body> </html> 