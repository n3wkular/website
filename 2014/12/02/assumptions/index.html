<!DOCTYPE html > <html lang="en-US"> <!-- Site Head --> <head> <meta charset="utf-8"> <title>Shantea Controls &#8226 Assumptions</title> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="shortcut icon" href="/images/favicon.png" title="Favicon"> <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet"> <!-- Importing Styles --> <link rel="stylesheet" href="/css/style.css"> <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/css/lightgallery-bundle.min.css"> <style> .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 45px;
    }
  
    @media (max-width: 767px) {
      .markdown-body {
        padding: 15px;
      }
    } </style> </head> <body> <!-- Page Loader --> <div id="page-loader" class="page-loader"><span class="load-icon"></span></div> <!-- Site Header --> <header class="site-header blog-header parallax" id="home" data-scrollax-parent="true"> <!-- Parallax Header Image --> <div class="parallax-wrapper"> <div class="cover" data-scrollax="properties: { 'translateY': '48%' }"> <img style="min-width: 100%;" src="/images/blog/header.jpg"> </div> </div> <div class="container"> <!-- Site Navigation Bar --> <div class="row site-navigation-bar parent"> <!-- Logo --> <div class="col-sm-2 col-xs-4 logo child-center-v"> <a href="/index.html"><img src="/images/logo_notext.svg" width="70"></a> </div> <!-- Toggle Mobile Menu --> <div class="col-xs-8 toggle-menu child-center-v"> <!-- Burger --> <div class="navTrigger"> <i></i><i></i><i></i> </div> </div> <!-- Navigation Bar --> <div class="col-sm-10 col-xs-12 navigation-bar child-center-v"> <!-- Navigation Menu --> <nav id="navMenu" class="nav-menu"> <ul class="menu"> <li><a href="/#about">ABOUT</a></li> <li><a href="/#features">FEATURES</a></li> <li><a href="/#parallax-features">SPECS</a></li> <li><a href="/#portfolio">GALLERY</a></li> <li><a href="/#testimonials">TESTIMONIALS</a></li> <li class="current-menu-item"><a href="/blog">BLOG</a></li> <li><a href="/#prices">OFFERS</a></li> <li><a href="/#contact">CONTACT</a></li> </ul> </nav> </div> </div> <!-- Site Header Banner --> <div class="row header-banner parent" data-scrollax="properties: { 'translateY': '48%', 'opacity': '1.4' }"> <div class="heading-content text-center child-center-v"> <!-- Heading Title --> <div class="row heading-title"> <h2>Shantea Controls</h2> <hr class="small"> <h1 class="thin">Assumptions</h1> </div> </div> </div> </div> </header> <!-- Page Section --> <section class="site-section blog-section page-layout" id="start"> <div class="container"> <!-- Page Layout --> <div class="row"> <!-- Sidebar --> <div class="col-md-4 hidden-xs hidden-sm"> <!-- Site Sidebar --> <aside class="site-sidebar"> <!-- Categories Widget --> <div class="widget categories-widget"> <!-- Widget Header --> <header class="widget-header"> <h4 class="widget-title">Categories</h4> </header> <!-- Widget Content --> <div class="widget-content"> <ul class="categories-box"> <li><a href="/category/info">info <span class="cat-count">8</span></a></li> <li><a href="/category/design">design <span class="cat-count">7</span></a></li> <li><a href="/category/build-log">build-log <span class="cat-count">9</span></a></li> <li><a href="/category/development">development <span class="cat-count">20</span></a></li> <li><a href="/category/programming">programming <span class="cat-count">5</span></a></li> </ul> </div> </div> </aside> </div> <!-- Content --> <div class="col-md-8 blog-articles-container"> <!-- Blog Article --> <div class="post-full"> <article class="blog-article blog-single-page clearfix"> <!-- Article Header --> <!-- Article Content --> <article class="markdown-body"> <p>In this post, I’m going to talk about collection of libraries that make up the OpenDeck platform, and why it’s important to really understand your code well.</p> <h2 id="arduino">Arduino</h2> <p>Before I start talking about Ownduino, I want to clarify what Arduino really is. Basically, it is an Atmel AVR microcontroller placed on a nice PCB with pin headers, combined with libraries that make the programming those chips so much easier, hiding away all the scary parts of embedded programming from user. Once you start dwelling into source code of most of the functions, you’ll find out that most of them have dozens of lines of code for performing really simple tasks, like reading the pins. But that is understandable, it’s the price you pay for convenience. After all, Arduino was never designed to give you the most of its hardware, it was designed to get you into the world of embedded programming really fast. What is not understandable is that most of Arduino code is really bad. Much of the code even goes against recommended approaches in Atmel ATmega datasheet, just take a look at serial functions. There is also a case of enabling many things by default, including lots of unnecessary code you don’t need most of the time. ‘You can’t manage something you can’t control’ is a nice thing I learned this year in college, and it applies perfectly here. Since I wanted to be in complete control over the code that runs on my platform, I created something called Ownduino. Not that creative name, but whatever.</p> <h2 id="ownduino">Ownduino</h2> <p>Ownduino is a lightweight library which contains only few of most used functions from Arduino, like Serial.begin(), Serial.write(), millis() and a couple more functions. You can check out rest of the features on <a href="https://github.com/paradajz/Ownduino">Ownduino GitHub</a>. Ownduino also gives user a choice to completely disable ADC, timer or Serial buffer. digitalRead, digitalWrite or String class are examples of what you will not find in Ownduino.</p> <h2 id="midi-library">MIDI library</h2> <p>For OpenDeck project I’m using modified Arduino MIDI library v3.2. I realize there is newer version available, but this one has worked flawlessly so far, and I don’t see that changing any time soon. However, I did modify it to more suit my needs. That’s the beauty of open source. Of course, all of the changes I made are published under OpenDeck GitHub repository. Most of the changes were pretty minor, like removing stuff I don’t need, and adding a option to enable or disable MIDI running status via MIDI System Exclusive.</p> <h3 id="midi-running-status-issues">MIDI running status issues</h3> <p>I do very little testing with <a href="http://www.altmustech.com/au-123.html">Altmustech AU-123</a> MIDI chip, since I’m only using it in finished products (controllers I sell). Because of that, I recently run into some issues when enabling MIDI running status by default. Running status is great in theory, you can read more about it <a href="http://www.blitter.com/~russtopia/MIDI/~jglatt/tech/midispec/run.htm">here</a>. However, most MIDI equipment still has issues with it, and it’s best to leave it disabled if unsure what to do. Anyways, MIDI chip I’m using started to misbehave when I enabled it, and it really took me a while before I figured what was wrong, because the same code worked without issues when using serial to MIDI conversions. Reason why this didn’t work is because USB MIDI actually prohibits running status - I didn’t know about that until this had happened. Lesson: never assume things will work. If they do, then there is most likely something wrong. It’s the only constant in universe.</p> <h3 id="system-exclusive">System Exclusive</h3> <p>Now this is a major issue, also discovered recently. It turned out that MIDI chip I’m using doesn’t really support MIDI SysEx, which means that with current OpenDeck setup, you are unable to configure anything using AU-123 - the core platform feature! Chip actually pretends it supports SysEx; it will gladly forward SysEx start and first byte after it, but it will also gladly ignore anything after first data byte, which renders its SysEx ‘support’ unusable. Not all is lost, however. I can still configure controller in emulated environment (virtual MIDI cable + HairlessMIDI + MIDI-OX), and because of this, I’m moving away from current ATmega328P setup to Arduino Pro Micro, with Atmega32u4 on it, which has USB support, so I can get rid of separate MIDI board.</p> <h2 id="code-optimizations">Code optimizations</h2> <p>Recently, I’ve discovered that I can send real time MIDI data from Traktor Pro to a MIDI controller. MIDI data in question is track volume. You can send volume data to controller to turn the LEDs on and off, resulting in VU-meter. The problem with previous version of OpenDeck was that code was too slow. Code used too much time to read the potentiometers, which affected timing of column switching inside matrix and reading of MIDI input. Result of all that was that code was unable to catch all incoming MIDI data, so some LEDs would’ve stayed on when they don’t need to be, and vice versa.</p> <h3 id="time-interrupts">Time interrupts</h3> <p>Thing I learned from this is that matrix switching should always be done inside a interrupt routine. It’s the only way of ensuring correct switching without any delays. <a href="https://github.com/paradajz/OpenDeck/blob/master/lib/OpenDeck/HardwareControl.cpp#L324">Placing matrix switching inside interrupt routine</a> was first thing I did to optimize the code. Second thing again boils down to knowing your code, something Arduino hides away from you.</p> <h3 id="adc-configuration">ADC configuration</h3> <p>In order to explain what I did, it’s necessary to understand how ADC inside ATmega works. When converting analog signal to digital one, ATmega takes samples of input signal at a certain speed, derived from microcontroller clock sped (16MHz). In order to control this speed, there are couple of prescalers available (ATmega328p datasheet, page 256):</p> <p><img src="/images/blog/screenshot086.png" alt=""></p> <p>By default, Arduino uses prescaler 128, which means it runs at 125kHz. Since single ADC conversion takes 13 cycles, that gives us a sample rate of 9.6kHz. Note however, that pushing the ADC clock up to 1MHz doesn’t have much of an influence on 8-bit values, and since MIDI requires 7-bit resolution, there is no reason not to exactly that, that is, to set the prescaler to 32, giving us a sample rate of 38kHz, much faster than the default. Because of this, I included a setADCprescaler function inside Ownduino, to make it easier for me:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void setADCprescaler(uint8\_t prescaler)
{

    //disable ADC before setting new prescaler ADCSRA &amp;= (0&lt;&lt;ADEN);
    switch(prescaler)
    {
        case 16:
        ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADEN);
        break;

        case 32:
        ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADPS0)|(1&lt;&lt;ADEN);
        break;

        case 64:
        ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADPS1)|(1&lt;&lt;ADEN);
        break;

        case 128:
        default: ADCSRA |= (1&lt;&lt;ADPS2)|(1&lt;&lt;ADPS1)|(1&lt;&lt;ADPS0)|(1&lt;&lt;ADEN);
        break;
    }
}
</code></pre></div></div> <p>Now, we get much faster analog read-out, and 8-bit precision. If you consider that ATmega328P has 10-bit ADC, and that ATmega328P is 8-bit microcontroller, ADC value is obviously stored inside two registers: ADCH (2 higher bits) and ADCL (8 lower bits). We can easily discard two bits, so that we need only one register. To do this, we can invert places where ADC value is stored by using this line:</p> <p><code class="language-plaintext highlighter-rouge">ADMUX |= (1&lt;&lt;ADLAR)</code>;</p> <p>Now, analog value is in the range 0-255, and when reading the value, we simply read ADCH register, eliminating the need to read extra register. Divide it by two, and we get nice 7-bit value required for MIDI.</p> <h2 id="conclusion">Conclusion</h2> <p>Together with doing matrix switching inside timer interrupt, code now performs much faster, and there are no more problems with sending lots of data to controller. You can check out VU-meter in action here:</p> <div class="videoWrapper"> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/0UBKplDQOXQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> </div> <p>So, in short:</p> <ol> <li>Never assume anything</li> <li>Know your code</li> </ol> <p>That would be all.</p> </article> <!-- Article Tool Boxes --> <div class="article-boxes"> <!-- Tags Box --> <div class="tags-article box"> <span class="title">Tags:</span> <ul class="tag-cloud-box box-content"> <li><a href="/tag/adc">adc</a></li> <li><a href="/tag/atmega328">atmega328</a></li> <li><a href="/tag/interrupts">interrupts</a></li> </ul> </div> <div id="hyvor-talk-view"></div> <script type="text/javascript"> var HYVOR_TALK_WEBSITE = 4484;
          var HYVOR_TALK_CONFIG = {
            url: 'https://shanteacontrols.com/2014/12/02/assumptions/',
            id: '/2014/12/02/assumptions/'
          }; </script> <script async type="text/javascript" src="//talk.hyvor.com/web-api/embed"></script> </div> </article> </div> </div> </div> </div> </section> <!-- Site Footer --> <footer class="site-footer" id="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-md-push-3 footer-info text-center"> <div class="footer-logo"> <img src="/images/logo.svg" width="700"> </div> <div class="footer-info-text"> <p></p> </div> <div class="social-icons"> <ul class="icons"> <li><a href="https://youtube.com/shanteacontrols" target="_blank"><i class="fi flaticon-youtube"></i></a></li> <li><a href="https://www.facebook.com/shanteacontrolsmidi" target="_blank"><i class="fi flaticon-facebook"></i></a></li> </ul> </div> </div> <div class="col-md-8 col-md-push-2 footer-copyright"> <div class="footer-text text-center"> <p>All Rights Reserved</p> <p><a href="https://shanteacontrols.com/">Shantea Controls</a> &copy; 2021</p> </div> </div> </div> </div> </footer> <!-- Go To Top Button --> <a href="#home" class="go-to-top-button"><i class="pe-7s-angle-up"></i></a> <!-- Importing Scripts --> <!-- jQuery CDN --> <script src="//ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script> <!-- If CDN fails than use local jQuery --> <script>window.jQuery || document.write('<script src="/js/jquery-3.0.0.min.js"><\/script>')</script> <!-- Owl Carousel --> <script src="/js/carousel.min.js" charset="utf-8"></script> <!-- Parallaxing & SmoothScroll --> <script src="/js/scrollax.min.js" charset="utf-8"></script> <!-- Main JS --> <script src="/js/main.js" charset="utf-8"></script> <!-- LightGallery --> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/lightgallery.umd.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/plugins/thumbnail/lg-thumbnail.umd.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.1.7/plugins/zoom/lg-zoom.umd.min.js"></script> <script type="text/javascript"> lightGallery(document.getElementById('gallery-container'), {
        plugins: [lgThumbnail],
        speed: 250,
        licenseKey: "xAIQA"
    }); </script> </body> </html> 